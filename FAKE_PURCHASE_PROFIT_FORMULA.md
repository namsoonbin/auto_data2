# ê°€êµ¬ë§¤ ë°˜ì˜ ìˆœì´ìµ ê³„ì‚°ì‹ ìƒì„¸ ë¶„ì„

## ğŸ“‹ ê°œìš”

ê°€êµ¬ë§¤(Fake Purchase)ê°€ ë°œìƒí–ˆì„ ë•Œ, ì‹¤ì œ ìˆœì´ìµì„ ì •í™•í•˜ê²Œ ê³„ì‚°í•˜ê¸° ìœ„í•œ ì¡°ì • ë¡œì§ ì„¤ëª…

**í•µì‹¬ ê°œë…**: ê°€êµ¬ë§¤ëŠ” ì‹¤ì œ íŒë§¤ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ë¬¼ê±´ì„ ë°›ì§€ ì•Šê³  í™˜ë¶ˆ/ì·¨ì†Œë˜ë¯€ë¡œ **ë§¤ì¶œì€ ì°¨ê°**ë˜ì§€ë§Œ **ë¹„ìš©ì€ ë°œìƒí•˜ì§€ ì•ŠìŒ**

---

## ğŸ”¢ ê¸°ë³¸ ìˆœì´ìµ ê³„ì‚° (ê°€êµ¬ë§¤ ì¡°ì • ì „)

### 1. IntegratedRecordì˜ ìˆœì´ìµ (database.py:128)

```python
net_profit = sales_amount - total_cost - (ad_cost Ã— 1.1)
```

**êµ¬ì„± ìš”ì†Œ**:
- `sales_amount`: ì¼ë³„ ì´ ë§¤ì¶œì•¡
- `total_cost`: ì´ ë¹„ìš© = (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸) Ã— íŒë§¤ ìˆ˜ëŸ‰
- `ad_cost Ã— 1.1`: ê´‘ê³ ë¹„ + ë¶€ê°€ì„¸ (10%)

### 2. ë‹¨ìœ„ë‹¹ ë¹„ìš© ê³„ì‚°

```python
unit_cost = cost_price + fee_amount + vat
```

**êµ¬ì„± ìš”ì†Œ**:
- `cost_price`: ë„ë§¤ê°€ (Korean cost)
- `fee_amount`: ìˆ˜ìˆ˜ë£Œ (ì¿ íŒ¡ ìˆ˜ìˆ˜ë£Œ ë“±)
- `vat`: ë¶€ê°€ì„¸ (10%)

### 3. ì´ ë¹„ìš© ê³„ì‚°

```python
total_cost = unit_cost Ã— sales_quantity
```

---

## ğŸ¯ ê°€êµ¬ë§¤ ì¡°ì • ë¡œì§

### 1. ê°€êµ¬ë§¤ ì¡°ì • ì •ë³´ ìƒì„± (adjustment_service.py)

ê°€êµ¬ë§¤ 1ê±´ë‹¹ ë‹¤ìŒ 3ê°€ì§€ ê°’ì„ ê³„ì‚°:

#### A. ë§¤ì¶œ ì°¨ê°ë¶„ (sales_deduction)

```python
sales_deduction = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
```

**ì˜ë¯¸**: ê°€êµ¬ë§¤ë¡œ ì¸í•œ í—ˆìœ„ ë§¤ì¶œì„ ì°¨ê°

**ì˜ˆì‹œ**:
- ê°€êµ¬ë§¤ ìˆ˜ëŸ‰: 2ê°œ
- ë‹¨ê°€: 50,000ì›
- `sales_deduction = 2 Ã— 50,000 = 100,000ì›`

#### B. ìˆ˜ëŸ‰ ì°¨ê°ë¶„ (quantity_deduction)

```python
quantity_deduction = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰
```

**ì˜ë¯¸**: ì‹¤ì œ íŒë§¤ë˜ì§€ ì•Šì€ ìˆ˜ëŸ‰

**ì˜ˆì‹œ**:
- ê°€êµ¬ë§¤ ìˆ˜ëŸ‰: 2ê°œ
- `quantity_deduction = 2ê°œ`

#### C. ë¹„ìš© ì ˆê°ë¶„ (cost_saved) â­ **í•µì‹¬**

```python
cost_saved = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸)
           = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— unit_cost
```

**ì˜ë¯¸**: ê°€êµ¬ë§¤ëŠ” ë§¤ì¶œë§Œ ë°œìƒí•˜ê³  ì‹¤ì œë¡œ ë¬¼ê±´ì„ ë°›ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, **ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•Šì•„ ì ˆê°ëœ ê¸ˆì•¡**

**ì˜ˆì‹œ**:
- ê°€êµ¬ë§¤ ìˆ˜ëŸ‰: 2ê°œ
- ë„ë§¤ê°€: 30,000ì›
- ìˆ˜ìˆ˜ë£Œ: 5,000ì›
- ë¶€ê°€ì„¸: 3,000ì›
- `unit_cost = 30,000 + 5,000 + 3,000 = 38,000ì›`
- `cost_saved = 2 Ã— 38,000 = 76,000ì›`

### 2. ê°€êµ¬ë§¤ ì¡°ì • ì ìš© (metrics.py:128)

```python
adjusted_profit = net_profit - sales_deduction + cost_saved
```

**ë¡œì§ ë¶„í•´**:

1. **ë§¤ì¶œ ì°¨ê°** (`- sales_deduction`)
   - ê°€êµ¬ë§¤ë¡œ ì¸í•œ í—ˆìœ„ ë§¤ì¶œì„ ìˆœì´ìµì—ì„œ ë¹¼ê¸°

2. **ë¹„ìš© ì ˆê° ì¶”ê°€** (`+ cost_saved`)
   - ì‹¤ì œë¡œ ë¬¼ê±´ì„ ë°›ì§€ ì•Šì•„ì„œ ì§€ë¶ˆí•˜ì§€ ì•Šì€ ë¹„ìš©ì„ ìˆœì´ìµì— ë”í•˜ê¸°

---

## ğŸ“Š ì „ì²´ ê³„ì‚°ì‹ í†µí•©

### ìµœì¢… ì¡°ì • ìˆœì´ìµ ê³µì‹

```python
# 1ë‹¨ê³„: ê¸°ë³¸ ìˆœì´ìµ ê³„ì‚°
net_profit = sales_amount - total_cost - (ad_cost Ã— 1.1)

# 2ë‹¨ê³„: ê°€êµ¬ë§¤ ì¡°ì •ê°’ ê³„ì‚°
sales_deduction = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
cost_saved = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸)

# 3ë‹¨ê³„: ì¡°ì • ìˆœì´ìµ ê³„ì‚°
adjusted_profit = net_profit - sales_deduction + cost_saved
```

### ì „ì²´ ê³µì‹ í•œ ì¤„ë¡œ í‘œí˜„

```python
adjusted_profit = (sales_amount - total_cost - ad_cost Ã— 1.1)
                  - (ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— ë‹¨ê°€)
                  + (ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸))
```

---

## ğŸ” êµ¬ì²´ì ì¸ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤

**íŒë§¤ ê¸°ë¡** (IntegratedRecord):
- ë‚ ì§œ: 2024-01-15
- ìƒí’ˆ: ë§¥ë¶ í”„ë¡œ
- íŒë§¤ ìˆ˜ëŸ‰: 5ê°œ
- ë‹¨ê°€: 2,000,000ì›
- ë§¤ì¶œì•¡ (sales_amount): 10,000,000ì›
- ë„ë§¤ê°€ (cost_price): 1,500,000ì›
- ìˆ˜ìˆ˜ë£Œ (fee_amount): 200,000ì›
- ë¶€ê°€ì„¸ (vat): 150,000ì›
- ê´‘ê³ ë¹„ (ad_cost): 500,000ì›

**ê°€êµ¬ë§¤ ê¸°ë¡** (FakePurchase):
- ë‚ ì§œ: 2024-01-15
- ìƒí’ˆ: ë§¥ë¶ í”„ë¡œ
- ê°€êµ¬ë§¤ ìˆ˜ëŸ‰: 2ê°œ
- ë‹¨ê°€: 2,000,000ì›

### ê³„ì‚° ê³¼ì •

#### 1ë‹¨ê³„: ê¸°ë³¸ ìˆœì´ìµ ê³„ì‚°

```python
unit_cost = 1,500,000 + 200,000 + 150,000 = 1,850,000ì›

total_cost = 1,850,000 Ã— 5 = 9,250,000ì›

net_profit = 10,000,000 - 9,250,000 - (500,000 Ã— 1.1)
           = 10,000,000 - 9,250,000 - 550,000
           = 200,000ì›
```

**ìˆœì´ìµ: 200,000ì›** (ê°€êµ¬ë§¤ ì¡°ì • ì „)

#### 2ë‹¨ê³„: ê°€êµ¬ë§¤ ì¡°ì •ê°’ ê³„ì‚°

```python
sales_deduction = 2 Ã— 2,000,000 = 4,000,000ì›

cost_saved = 2 Ã— 1,850,000 = 3,700,000ì›
```

#### 3ë‹¨ê³„: ì¡°ì • ìˆœì´ìµ ê³„ì‚°

```python
adjusted_profit = 200,000 - 4,000,000 + 3,700,000
                = -100,000ì›
```

**ì¡°ì • ìˆœì´ìµ: -100,000ì›** (ì‹¤ì œë¡œëŠ” ì ì)

### ê²€ì¦

**ì‹¤ì œ ìƒí™© ë¶„ì„**:
- ì‹¤ì œ íŒë§¤: 3ê°œ (5ê°œ - 2ê°œ ê°€êµ¬ë§¤)
- ì‹¤ì œ ë§¤ì¶œ: 6,000,000ì› (3ê°œ Ã— 2,000,000ì›)
- ì‹¤ì œ ë¹„ìš©: 5,550,000ì› (3ê°œ Ã— 1,850,000ì›)
- ê´‘ê³ ë¹„: 550,000ì›
- **ì‹¤ì œ ìˆœì´ìµ: 6,000,000 - 5,550,000 - 550,000 = -100,000ì›** âœ…

**ê³µì‹ ê²€ì¦ ì™„ë£Œ!**

---

## ğŸ’¡ ì™œ ì´ë ‡ê²Œ ê³„ì‚°í•˜ëŠ”ê°€?

### ê°€êµ¬ë§¤ì˜ íŠ¹ì„±

ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ì‹œìŠ¤í…œì—ì„œ ê°€êµ¬ë§¤ëŠ”:

1. **ë§¤ì¶œ ë°ì´í„°ì— í¬í•¨ë¨** (ì‹œìŠ¤í…œì— íŒë§¤ë¡œ ê¸°ë¡)
2. **ì‹¤ì œë¡œëŠ” í™˜ë¶ˆ/ì·¨ì†Œë¨** (ë¬¼ê±´ì„ ë°›ì§€ ì•ŠìŒ)
3. **ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ** (ë¬¼ê±´ì„ ë°›ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ)

### ì¡°ì •ì˜ í•„ìš”ì„±

**ì¡°ì •í•˜ì§€ ì•Šìœ¼ë©´**:
- ë§¤ì¶œì´ ë¶€í’€ë ¤ì ¸ ë³´ì„
- ìˆœì´ìµì´ ì‹¤ì œë³´ë‹¤ ë‚®ê²Œ ê³„ì‚°ë¨ (ë¹„ìš©ì´ ê³¼ë‹¤ ê³„ì‚°)

**ì¡°ì •í•˜ë©´**:
- ì‹¤ì œ íŒë§¤ëœ ìˆ˜ëŸ‰ê³¼ ë§¤ì¶œ ë°˜ì˜
- ì‹¤ì œë¡œ ë°œìƒí•œ ë¹„ìš©ë§Œ ê³„ì‚°
- **ì •í™•í•œ ìˆœì´ìµ ë„ì¶œ** âœ…

---

## ğŸ”§ êµ¬í˜„ ìœ„ì¹˜

### 1. ê°€êµ¬ë§¤ ë¹„ìš© ê³„ì‚° (database.py:251-264)

```python
def calculate_fake_purchase_cost(self):
    """ê°€êµ¬ë§¤ ë¹„ìš© ê³„ì‚° (ì°¸ê³ ìš©)

    Formula:
    - ë‹¨ìœ„ë‹¹ ë¹„ìš© = (ìƒí’ˆê°€ê²© Ã— 12%) + 4500ì›
    - ì´ ë¹„ìš© = ë‹¨ìœ„ë‹¹ ë¹„ìš© Ã— ê°€êµ¬ë§¤ ê°œìˆ˜
    """
    if self.unit_price and self.quantity:
        self.calculated_cost = (self.unit_price * 0.12) + 4500
        self.total_cost = self.calculated_cost * self.quantity
```

**Note**: ì´ ë¹„ìš©ì€ ê°€êµ¬ë§¤ ë°œìƒ ì‹œ ì‹¤ì œë¡œ ì§€ë¶ˆí•˜ëŠ” ìˆ˜ìˆ˜ë£Œ (12% + 4,500ì›)ì´ë©°, **ìˆœì´ìµ ì¡°ì •ê³¼ëŠ” ë³„ê°œ**ì…ë‹ˆë‹¤.

### 2. ê°€êµ¬ë§¤ ì¡°ì • ì •ë³´ ìƒì„± (adjustment_service.py:19-128)

```python
def build_fake_purchase_adjustments(...):
    # ê°€êµ¬ë§¤ ë°ì´í„° ì¡°íšŒ
    fake_purchases = fake_query.all()

    for fp in fake_purchases:
        # ë§¤ì¶œ ì°¨ê°ë¶„
        sales_deduction = (fp.quantity or 0) * (fp.unit_price or 0)

        # ë¹„ìš© ì ˆê°ë¶„
        cost_price, fee_amount, vat = unit_cost_map[key]
        unit_cost = cost_price + fee_amount + vat
        cost_saved = (fp.quantity or 0) * unit_cost

        fake_purchase_adjustments[key] = {
            'sales_deduction': sales_deduction,
            'quantity_deduction': fp.quantity or 0,
            'cost_saved': cost_saved
        }
```

### 3. ì¡°ì • ì ìš© (metrics.py:116-130)

```python
for record in records:
    adjustment = fake_purchase_adjustments.get(adjustment_key, {})

    sales_deduction = adjustment.get('sales_deduction', 0)
    quantity_deduction = adjustment.get('quantity_deduction', 0)
    cost_saved = adjustment.get('cost_saved', 0)

    # ì¡°ì • ìˆœì´ìµ ê³„ì‚°
    adjusted_profit = record.net_profit - sales_deduction + cost_saved
    adjusted_sales = record.sales_amount - sales_deduction
    adjusted_quantity = record.sales_quantity - quantity_deduction
    adjusted_total_cost = record.total_cost - cost_saved
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ê°€êµ¬ë§¤ ë¹„ìš© vs ë¹„ìš© ì ˆê°ë¶„

**í˜¼ë™í•˜ì§€ ë§ ê²ƒ**:

- **ê°€êµ¬ë§¤ ë¹„ìš©** (`FakePurchase.calculated_cost`):
  - ê°€êµ¬ë§¤ ë°œìƒ ì‹œ ì§€ë¶ˆí•˜ëŠ” ìˆ˜ìˆ˜ë£Œ: `(ë‹¨ê°€ Ã— 12%) + 4,500ì›`
  - ìˆœì´ìµ ì¡°ì •ê³¼ **ë¬´ê´€**

- **ë¹„ìš© ì ˆê°ë¶„** (`cost_saved`):
  - ìˆœì´ìµ ì¡°ì •ì— ì‚¬ìš©: `ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸)`
  - ì‹¤ì œë¡œ ë¬¼ê±´ì„ ë°›ì§€ ì•Šì•„ ë°œìƒí•˜ì§€ ì•Šì€ ë¹„ìš©

### 2. ìŒìˆ˜ ìˆ˜ëŸ‰ ê²€ì¦

ê°€êµ¬ë§¤ ìˆ˜ëŸ‰ì´ ì‹¤ì œ íŒë§¤ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ë©´ ê²½ê³  ë¡œê·¸:

```python
if adjusted_quantity < 0:
    logger.warning(
        f"ìŒìˆ˜ ìˆ˜ëŸ‰ ë°œìƒ: date={record.date}, option_id={record.option_id}, "
        f"sales_quantity={record.sales_quantity}, quantity_deduction={quantity_deduction}"
    )
```

**ì›ì¸**: ê°€êµ¬ë§¤ ë°ì´í„° ì…ë ¥ ì˜¤ë¥˜ ë˜ëŠ” IntegratedRecordì™€ ë¶ˆì¼ì¹˜

### 3. ì¤‘ë³µ ë ˆì½”ë“œ ë°©ì§€

ë™ì¼ (tenant_id, option_id, date) ì¡°í•©ì€ **Unique Constraint**ë¡œ ë°©ì§€:

```python
# database.py:222
UniqueConstraint('tenant_id', 'option_id', 'date', name='uix_fake_tenant_option_date')
```

---

## ğŸ“š ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  | ë¼ì¸ |
|------|------|------|
| `services/database.py` | FakePurchase ëª¨ë¸, IntegratedRecord ëª¨ë¸ | 59-265 |
| `services/adjustment_service.py` | ê°€êµ¬ë§¤ ì¡°ì • ë¡œì§ ìƒì„± | 19-165 |
| `routers/metrics.py` | ì¡°ì • ì ìš© ë° ì§‘ê³„ | 116-232 |
| `routers/fake_purchases.py` | ê°€êµ¬ë§¤ CRUD API | 1-409 |

---

## âœ… ìš”ì•½

### ê°€êµ¬ë§¤ ë°˜ì˜ ìˆœì´ìµ ìµœì¢… ê³µì‹

```
ì¡°ì • ìˆœì´ìµ = ê¸°ë³¸ ìˆœì´ìµ - ë§¤ì¶œ ì°¨ê°ë¶„ + ë¹„ìš© ì ˆê°ë¶„

where:
  ê¸°ë³¸ ìˆœì´ìµ = ë§¤ì¶œì•¡ - ì´ë¹„ìš© - (ê´‘ê³ ë¹„ Ã— 1.1)
  ë§¤ì¶œ ì°¨ê°ë¶„ = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— ë‹¨ê°€
  ë¹„ìš© ì ˆê°ë¶„ = ê°€êµ¬ë§¤_ìˆ˜ëŸ‰ Ã— (ë„ë§¤ê°€ + ìˆ˜ìˆ˜ë£Œ + ë¶€ê°€ì„¸)
```

### í•µì‹¬ ì›ë¦¬

1. **ë§¤ì¶œ ì°¨ê°**: ê°€êµ¬ë§¤ëŠ” ì‹¤ì œ ë§¤ì¶œì´ ì•„ë‹ˆë¯€ë¡œ ë¹¼ê¸°
2. **ë¹„ìš© ì ˆê° ì¶”ê°€**: ë¬¼ê±´ì„ ë°›ì§€ ì•Šì•„ ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë”í•˜ê¸°
3. **ì •í™•í•œ ìˆœì´ìµ**: ì‹¤ì œ ê±°ë˜ë§Œ ë°˜ì˜í•˜ì—¬ ì •í™•í•œ ìˆ˜ìµì„± íŒŒì•…

---

**ì‘ì„±ì¼**: 2025-11-17
**ë²„ì „**: 1.0
